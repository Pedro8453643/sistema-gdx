<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scanner Inteligente</title>

<script async src="https://docs.opencv.org/4.x/opencv.js"></script>

<style>
body{
margin:0;
font-family:system-ui;
background:linear-gradient(180deg,#020617,#0f172a);
display:flex;
flex-direction:column;
align-items:center;
color:white;
min-height:100vh;
}

header{
width:100%;
text-align:center;
padding:18px;
font-weight:600;
background:#020617;
}

#scanner{
margin-top:25px;
width:92%;
max-width:380px;
background:#020617;
border-radius:20px;
padding:16px;
box-shadow:0 20px 40px rgba(0,0,0,0.6);
}

#cameraBox{
position:relative;
height:260px;
border-radius:16px;
overflow:hidden;
border:2px solid #22c55e;
}

video{
width:100%;
height:100%;
object-fit:cover;
}

#laser{
position:absolute;
width:100%;
height:3px;
background:red;
box-shadow:0 0 10px red;
animation:scan 2s linear infinite;
}

@keyframes scan{
0%{top:0}
100%{top:100%}
}

#status{
margin-top:12px;
text-align:center;
font-size:14px;
opacity:0.8;
}

button{
width:100%;
margin-top:15px;
padding:14px;
border:none;
border-radius:14px;
font-size:16px;
font-weight:600;
cursor:pointer;
}

.ligado{background:#22c55e;}
.desligado{background:#ef4444;}

footer{
margin-top:auto;
padding:18px;
font-size:12px;
opacity:0.6;
}
</style>
</head>

<body>

<header>Scanner de Triângulo</header>

<div id="scanner">

<div id="cameraBox">
<video id="video" autoplay playsinline></video>
<div id="laser"></div>
</div>

<div id="status">Mostre um triângulo em papel branco</div>

<button id="toggleBtn" class="ligado">Scanner Ligado</button>

</div>

<footer>feito por Pedro Henrique para isabella</footer>

<canvas id="canvas" style="display:none;"></canvas>

<script>
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const statusText=document.getElementById("status");
const toggleBtn=document.getElementById("toggleBtn");

let ligado=true;
let tocando=false;
let audioCtx;

// botão
toggleBtn.onclick=()=>{
ligado=!ligado;

if(ligado){
toggleBtn.className="ligado";
toggleBtn.textContent="Scanner Ligado";
}else{
toggleBtn.className="desligado";
toggleBtn.textContent="Scanner Desligado";
}
};

// som estilo scanner de mercado
function beep(){
if(!audioCtx){
audioCtx=new(window.AudioContext||window.webkitAudioContext)();
}

const osc=audioCtx.createOscillator();
const gain=audioCtx.createGain();

osc.type="square";
osc.frequency.value=1800;

osc.connect(gain);
gain.connect(audioCtx.destination);

osc.start();
tocando=true;

statusText.textContent="Triângulo detectado";

if(navigator.vibrate) navigator.vibrate(150);

setTimeout(()=>{
osc.stop();
tocando=false;
statusText.textContent="Mostre um triângulo em papel branco";
},1500);
}

// câmera
navigator.mediaDevices.getUserMedia({
video:{facingMode:"environment"}
}).then(stream=>{
video.srcObject=stream;
});

// detectar triângulo
function detectar(){
if(!ligado||tocando||!cv||!video.videoWidth) return;

canvas.width=video.videoWidth;
canvas.height=video.videoHeight;

ctx.drawImage(video,0,0);

let src=cv.imread(canvas);
let gray=new cv.Mat();

cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);

// verificar fundo claro
let media=cv.mean(gray)[0];
if(media<170){
src.delete();
gray.delete();
return;
}

let blur=new cv.Mat();
cv.GaussianBlur(gray,blur,new cv.Size(5,5),0);

let edges=new cv.Mat();
cv.Canny(blur,edges,60,120);

let contours=new cv.MatVector();
let hierarchy=new cv.Mat();

cv.findContours(edges,contours,hierarchy,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);

for(let i=0;i<contours.size();i++){
let cnt=contours.get(i);
let peri=cv.arcLength(cnt,true);
let approx=new cv.Mat();

cv.approxPolyDP(cnt,approx,0.04*peri,true);

// TRIÂNGULO = 3 lados
if(approx.rows===3){
beep();
approx.delete();
break;
}

approx.delete();
}

src.delete();
gray.delete();
blur.delete();
edges.delete();
contours.delete();
hierarchy.delete();
}

setInterval(detectar,200);
</script>

</body>
</html>
