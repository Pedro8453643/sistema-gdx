<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scanner de Círculo</title>

<script async src="https://docs.opencv.org/4.x/opencv.js"></script>

<style>
body{
margin:0;
background:linear-gradient(180deg,#0f172a,#020617);
font-family:system-ui;
display:flex;
flex-direction:column;
align-items:center;
color:white;
min-height:100vh;
}

header{
width:100%;
padding:18px;
text-align:center;
font-size:18px;
font-weight:600;
background:#020617;
border-bottom:1px solid rgba(255,255,255,0.05);
}

#scanner{
margin-top:25px;
width:92%;
max-width:380px;
background:#020617;
border-radius:22px;
padding:16px;
box-shadow:0 20px 50px rgba(0,0,0,0.6);
}

#cameraBox{
position:relative;
height:260px;
border-radius:16px;
overflow:hidden;
border:2px solid #22c55e;
}

video{
width:100%;
height:100%;
object-fit:cover;
}

#laser{
position:absolute;
width:100%;
height:3px;
background:#ff2d2d;
box-shadow:0 0 12px red;
animation:scan 2s linear infinite;
}

@keyframes scan{
0%{top:0}
100%{top:100%}
}

#status{
margin-top:12px;
text-align:center;
font-size:14px;
opacity:0.85;
}

button{
width:100%;
margin-top:16px;
padding:14px;
border:none;
border-radius:14px;
font-size:16px;
font-weight:600;
cursor:pointer;
transition:0.2s;
}

.ligado{
background:#22c55e;
}

.desligado{
background:#ef4444;
}

footer{
margin-top:auto;
padding:18px;
font-size:12px;
opacity:0.6;
}
</style>
</head>

<body>

<header>Scanner Inteligente</header>

<div id="scanner">

<div id="cameraBox">
<video id="video" autoplay playsinline></video>
<div id="laser"></div>
</div>

<div id="status">Mostre um círculo em papel branco</div>

<button id="toggleBtn" class="ligado">Scanner Ligado</button>

</div>

<footer>feito por Pedro Henrique para isabella</footer>

<canvas id="canvas" style="display:none;"></canvas>

<script>
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const statusText=document.getElementById("status");
const toggleBtn=document.getElementById("toggleBtn");

let ligado=true;
let tocando=false;
let audioCtx;

// botão
toggleBtn.onclick=()=>{
ligado=!ligado;

if(ligado){
toggleBtn.className="ligado";
toggleBtn.textContent="Scanner Ligado";
statusText.textContent="Mostre um círculo em papel branco";
}else{
toggleBtn.className="desligado";
toggleBtn.textContent="Scanner Desligado";
statusText.textContent="Scanner pausado";
}
};

// som
function beep(){
if(!audioCtx){
audioCtx=new(window.AudioContext||window.webkitAudioContext)();
}

const osc=audioCtx.createOscillator();
const gain=audioCtx.createGain();

osc.frequency.value=1050;

osc.connect(gain);
gain.connect(audioCtx.destination);

osc.start();
tocando=true;

statusText.textContent="Círculo válido detectado";

if(navigator.vibrate) navigator.vibrate(200);

setTimeout(()=>{
osc.stop();
tocando=false;
statusText.textContent="Mostre um círculo em papel branco";
},1500);
}

// câmera
navigator.mediaDevices.getUserMedia({
video:{facingMode:"environment"}
}).then(stream=>{
video.srcObject=stream;
});

// detecção especializada
function detectar(){
if(!ligado||tocando||!cv) return;

canvas.width=video.videoWidth;
canvas.height=video.videoHeight;

ctx.drawImage(video,0,0);

let src=cv.imread(canvas);
let gray=new cv.Mat();

cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);

// verificar se fundo é claro (papel)
let media=cv.mean(gray)[0];

if(media<180){
src.delete();
gray.delete();
return;
}

cv.GaussianBlur(gray,gray,new cv.Size(9,9),2);

let circles=new cv.Mat();

cv.HoughCircles(
gray,
circles,
cv.HOUGH_GRADIENT,
1,
80,
120,
40,
30,
200
);

// somente 1 círculo
if(circles.cols===1){
beep();
}

src.delete();
gray.delete();
circles.delete();
}

setInterval(detectar,250);
</script>

</body>
</html>
