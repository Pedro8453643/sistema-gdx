<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scanner de Círculos</title>

<script async src="https://docs.opencv.org/4.x/opencv.js"></script>

<style>
body{
margin:0;
background:#0f172a;
font-family:Arial;
display:flex;
flex-direction:column;
align-items:center;
color:white;
}

header{
width:100%;
padding:14px;
text-align:center;
background:#020617;
font-weight:bold;
}

#scanner{
margin-top:20px;
width:92%;
max-width:360px;
background:#020617;
border-radius:18px;
padding:15px;
box-shadow:0 10px 30px rgba(0,0,0,0.6);
}

#cameraBox{
position:relative;
height:260px;
border-radius:14px;
overflow:hidden;
border:3px solid #22c55e;
}

video{
width:100%;
height:100%;
object-fit:cover;
}

#laser{
position:absolute;
width:100%;
height:3px;
background:red;
box-shadow:0 0 10px red;
animation:scan 2s linear infinite;
}

@keyframes scan{
0%{top:0}
100%{top:100%}
}

button{
width:100%;
margin-top:15px;
padding:14px;
border:none;
border-radius:12px;
font-size:16px;
font-weight:bold;
cursor:pointer;
}

.ligado{background:#22c55e;}
.desligado{background:#ef4444;}

#status{
margin-top:10px;
text-align:center;
font-size:14px;
}
</style>
</head>

<body>

<header>Scanner de Círculos</header>

<div id="scanner">

<div id="cameraBox">
<video id="video" autoplay playsinline></video>
<div id="laser"></div>
</div>

<div id="status">Procurando círculo...</div>

<button id="toggleBtn" class="ligado">Scanner Ligado</button>

</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const statusText=document.getElementById("status");
const toggleBtn=document.getElementById("toggleBtn");

let ligado=true;
let tocando=false;
let audioCtx;

// botão
toggleBtn.onclick=()=>{
ligado=!ligado;

if(ligado){
toggleBtn.className="ligado";
toggleBtn.textContent="Scanner Ligado";
}else{
toggleBtn.className="desligado";
toggleBtn.textContent="Scanner Desligado";
}
};

// som
function beep(){
if(!audioCtx){
audioCtx=new(window.AudioContext||window.webkitAudioContext)();
}

const osc=audioCtx.createOscillator();
const gain=audioCtx.createGain();

osc.frequency.value=1100;
osc.connect(gain);
gain.connect(audioCtx.destination);

osc.start();
tocando=true;

statusText.textContent="Círculo detectado";

if(navigator.vibrate) navigator.vibrate(200);

setTimeout(()=>{
osc.stop();
tocando=false;
statusText.textContent="Procurando círculo...";
},1500);
}

// câmera
navigator.mediaDevices.getUserMedia({
video:{facingMode:"environment"}
}).then(stream=>{
video.srcObject=stream;
});

// detecção de círculo
function detectarCirculo(){
if(!ligado||tocando||!cv) return;

canvas.width=video.videoWidth;
canvas.height=video.videoHeight;

ctx.drawImage(video,0,0);

let src=cv.imread(canvas);
let gray=new cv.Mat();
cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);

cv.GaussianBlur(gray,gray,new cv.Size(9,9),1.5);

let circles=new cv.Mat();

cv.HoughCircles(
gray,
circles,
cv.HOUGH_GRADIENT,
1,
50,
120,
30,
20,
200
);

if(circles.cols>0){
beep();
}

src.delete();
gray.delete();
circles.delete();
}

setInterval(detectarCirculo,300);
</script>

</body>
</html>
